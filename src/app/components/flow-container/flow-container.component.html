<div class="absolute inset-0" 
     (pointerup)="onCanvasPointerUp($event)" 
     (dragover)="onDragOver($event)" 
     (drop)="onDrop($event)">
  <!-- Débogage: Afficher le nombre de nœuds -->
  <div class="absolute top-0 right-0 bg-white p-2 text-xs z-50" *ngIf="false">
    Nodes: {{ flowService.nodes.length }}
  </div>
  
  <f-flow #flow fDraggable
          [attr.data-dragging]="flowService.draggingItemType ? 'true' : 'false'"
          (fCreateNode)="onCreateNode($event)"
          (fCreateConnection)="onCreateConnection($event)">
    <f-connection-for-create fBehavior="floating"></f-connection-for-create>
    <f-canvas #canvas fZoom>
      <!-- Les nœuds permanents -->
      @for (node of flowService.nodes; track node.id) {
        <div fNode 
             [fNodePosition]="node.position || {x: 0, y: 0}" 
             fNodeOutput 
             [fOutputId]="'output_' + node.id" 
             [fOutputMultiple]="node.maxOutputs !== 1"
             fOutputConnectableSide="right"
             fNodeInput
             [fInputId]="'input_' + node.id"
             [fInputMultiple]="node.maxInputs !== 1"
             fInputConnectableSide="right"
             [ngClass]="flowService.getNodeClass(node.type)">
          <div class="p-3 flex items-center font-medium text-white">
            <span class="mr-2 text-xl">{{ flowService.getNodeIcon(node.type) }}</span>
            <span>{{ node.type }}</span>
          </div>
          <div class="p-3 bg-white text-gray-700">
            {{ node.text }}
            <!-- Indicateur pour les limites spéciales -->
            <ng-container *ngIf="node.type === 'BinarySplit'">
              <div class="mt-2 text-xs text-indigo-600 bg-indigo-50 p-1 rounded-sm">
                <div class="flex items-center mb-1">
                  <span class="inline-block w-3 h-3 bg-indigo-600 rounded-full mr-1"></span>
                  <span>1 entrée maximum</span>
                </div>
                <div class="flex items-center">
                  <span class="inline-block w-3 h-3 bg-indigo-600 rounded-full mr-1"></span>
                  <span>2 sorties exactement</span>
                </div>
              </div>
            </ng-container>
            <ng-container *ngIf="node.type === 'MultiSplit'">
              <div class="mt-2 text-xs text-teal-600 bg-teal-50 p-1 rounded-sm">
                <div class="flex items-center mb-1">
                  <span class="inline-block w-3 h-3 bg-teal-600 rounded-full mr-1"></span>
                  <span>1 entrée maximum</span>
                </div>
                <div class="flex items-center">
                  <span class="inline-block w-3 h-3 bg-teal-600 rounded-full mr-1"></span>
                  <span>Jusqu'à 5 sorties</span>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      }
      
      <!-- Les nœuds temporaires (emplacements potentiels) -->
      @for (node of flowService.temporaryNodes; track node.id) {
        <div fNode 
             [fNodePosition]="node.position || {x: 0, y: 0}" 
             fNodeOutput 
             [fOutputId]="'output_' + node.id" 
             [fOutputMultiple]="node.maxOutputs !== 1"
             fOutputConnectableSide="right"
             fNodeInput
             [fInputId]="'input_' + node.id"
             [fInputMultiple]="node.maxInputs !== 1"
             fInputConnectableSide="right"
             class="min-w-[180px] rounded-md shadow-md overflow-hidden bg-gradient-to-r from-green-50 to-green-100 opacity-90 border-2 border-dashed border-green-500 cursor-pointer temporary-node hover:scale-105 hover:shadow-lg transition-all"
             [attr.data-node-id]="node.id"
             appTemporaryNode
             [nodeId]="node.id"
             (dropOnNode)="onDropOnTemporaryNode($event)">
          <div class="p-3 flex items-center font-medium text-white bg-green-500">
            <span class="mr-2 text-xl">{{ flowService.getNodeIcon(node.type) }}</span>
            <span>{{ node.type }}</span>
          </div>
          <div class="p-3 bg-white text-gray-700 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-green-600 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Drop here to connect</span>
          </div>
        </div>
      }
      
      <!-- Connexions entre les nœuds permanents -->
      @for (connection of flowService.connections; track connection.id) {
        <f-connection 
          [fOutputId]="connection.sourceId" 
          [fInputId]="connection.targetId"
          fBehavior="floating">
        </f-connection>
      }
      
      <!-- Connexions temporaires -->
      @for (connection of flowService.temporaryConnections; track connection.id) {
        <f-connection 
          [fOutputId]="connection.sourceId" 
          [fInputId]="connection.targetId"
          fBehavior="floating"
          class="opacity-80 temporary-connection"
          style="--f-connection-stroke: #10b981; --f-connection-stroke-width: 2px; --f-connection-stroke-dasharray: 5,3;">
        </f-connection>
      }
    </f-canvas>
    
    <!-- Ajout d'un fond quadrillé -->
    <f-background></f-background>
    
  </f-flow>
  
  <!-- Toolbar flottante -->
  <app-flow-toolbar></app-flow-toolbar>
</div> 