<div class="absolute inset-0" 
     (dragover)="onDragOver($event)" 
     (drop)="onDrop($event)">
  <!-- Débogage: Afficher le nombre de nœuds -->
  @if (false) {
    <div class="absolute top-0 right-0 bg-white p-2 text-xs z-50">
      Nodes: {{ flowStateService.nodes().length }}
    </div>
  }
  
  <f-flow #flow fDraggable
          (fSelectionChange)="onSelectionChange($event)"
          [attr.data-dragging]="flowStateService.draggingItemType() ? 'true' : 'false'"
          (fCreateNode)="onCreateNode($event)"
          (fCreateConnection)="onCreateConnection($event)">
          <f-selection-area></f-selection-area>
    <f-connection-for-create fBehavior="floating"></f-connection-for-create>
    <f-canvas #canvas fZoom>
      <!-- Les nœuds permanents -->
      @for (node of flowStateService.nodes(); track node.id) {
        <div fNode 
             [fNodePosition]="node.position || {x: 0, y: 0}"
             fNodeOutput 
             [fOutputId]="'output_' + node.id" 
             [fOutputMultiple]="node.maxOutputs !== 1"
             fOutputConnectableSide="right"
             fNodeInput
             [fInputId]="'input_' + node.id"
             [fInputMultiple]="node.maxInputs !== 1"
             fInputConnectableSide="right"
             class="w-[200px] rounded-md overflow-hidden border border-gray-200 bg-white">
          <div class="p-3 flex items-center">
            <div class="w-10 h-10 flex items-center justify-center rounded-md bg-gray-100 mr-3">
              <span class="text-lg text-gray-700">{{ flowService.getNodeIcon(node.type) }}</span>
            </div>
            <span class="font-medium text-gray-800">{{ node.type }}</span>
          </div>
        </div>
      }
      
      <!-- Les nœuds temporaires (emplacements potentiels) -->
      @for (node of flowStateService.temporaryNodes(); track node.id) {
        <div fNode 
             [fNodePosition]="node.position || {x: 0, y: 0}" 
             fNodeOutput 
             [fOutputId]="'output_' + node.id" 
             [fOutputMultiple]="node.maxOutputs !== 1"
             fOutputConnectableSide="right"
             fNodeInput
             [fInputId]="'input_' + node.id"
             [fInputMultiple]="node.maxInputs !== 1"
             fInputConnectableSide="right"
             class="w-[200px] rounded-md overflow-hidden bg-white border-2 border-gray-200 border-dashed cursor-pointer temporary-node hover:border-green-400 transition-all"
             [attr.data-node-id]="node.id"
             appTemporaryNode
             [nodeId]="node.id"
             (dropOnNode)="onDropOnTemporaryNode($event)">
          <div class="p-3 flex items-center">
            <div class="w-10 h-10 flex items-center justify-center rounded-md bg-gray-100 mr-3">
              <span class="text-lg text-gray-400">{{ flowService.getNodeIcon(node.type) }}</span>
            </div>
            <span class="font-medium text-gray-400">{{ node.type }}</span>
          </div>
        </div>
      }
      
      <!-- Connexions entre les nœuds permanents -->
      @for (connection of flowStateService.connections(); track connection.id) {
        <f-connection 
          [fOutputId]="connection.sourceId" 
          [fInputId]="connection.targetId"
          fBehavior="floating">
        </f-connection>
      }
      
      <!-- Connexions temporaires -->
      @for (connection of flowStateService.temporaryConnections(); track connection.id) {
        <f-connection 
          [fOutputId]="connection.sourceId" 
          [fInputId]="connection.targetId"
          fBehavior="floating"
          class="opacity-80 temporary-connection"
          style="--f-connection-stroke: #10b981; --f-connection-stroke-width: 2px; --f-connection-stroke-dasharray: 5,3;">
        </f-connection>
      }
    </f-canvas>
    
    <!-- Ajout d'un fond quadrillé -->
    <f-background></f-background>
    
  </f-flow>
  
  <!-- Toolbar flottante -->
  <app-flow-toolbar></app-flow-toolbar>
</div>